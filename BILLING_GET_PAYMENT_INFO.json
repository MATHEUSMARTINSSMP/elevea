{
  "name": "Billing - Get Payment Info (Dashboard)",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "api/billing/get-payment-info",
        "responseMode": "lastNode",
        "options": {}
      },
      "id": "webhook-payment-info",
      "name": "ğŸ’° Webhook - Get Payment Info",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [-240, 300],
      "webhookId": "elevea-payment-info"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT client_id AS id, site_slug, email, name, plan, status, last_payment, payment_amount, created_at FROM elevea.clients WHERE site_slug = $1 LIMIT 1",
        "options": {
          "queryReplacement": "={{ [$json.body.siteSlug] }}"
        }
      },
      "id": "find-client",
      "name": "ğŸ” PostgreSQL - Find Client",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [0, 300],
      "credentials": {
        "postgres": {
          "id": "S2Hp22T5AgilJMEy",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT payment_id, amount_paid, status, payment_date, payment_method, description, created_at FROM elevea.payments WHERE site_slug = $1 ORDER BY payment_date DESC, created_at DESC LIMIT 10",
        "options": {
          "queryReplacement": "={{ [$json.body.siteSlug] }}"
        }
      },
      "id": "get-payments",
      "name": "ğŸ’° PostgreSQL - Get Payments",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [240, 300],
      "credentials": {
        "postgres": {
          "id": "S2Hp22T5AgilJMEy",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Formatar informaÃ§Ãµes de pagamento para o dashboard\nconst out = [];\nconst clientData = $('ğŸ” PostgreSQL - Find Client').item.json.rows?.[0] || {};\nconst payments = $('ğŸ’° PostgreSQL - Get Payments').item.json.rows || [];\n\nif (!clientData.client_id) {\n  out.push({\n    json: {\n      success: false,\n      code: 404,\n      message: 'Cliente nÃ£o encontrado',\n      timestamp: new Date().toISOString()\n    }\n  });\n  return out;\n}\n\n// Ãšltimo pagamento aprovado\nconst lastApprovedPayment = payments.find(p => p.status === 'approved') || null;\n\n// Calcular prÃ³ximo pagamento\nlet nextPayment = null;\nlet daysUntilPayment = null;\nlet isOverdue = false;\nlet paymentStatus = 'unknown';\n\nif (lastApprovedPayment && lastApprovedPayment.payment_date) {\n  const lastPaymentDate = new Date(lastApprovedPayment.payment_date);\n  nextPayment = new Date(lastPaymentDate);\n  nextPayment.setDate(nextPayment.getDate() + 30); // +30 dias\n  \n  const now = new Date();\n  const diffTime = nextPayment - now;\n  daysUntilPayment = Math.ceil(diffTime / (1000 * 60 * 60 * 24));\n  \n  if (daysUntilPayment < 0) {\n    isOverdue = true;\n    paymentStatus = 'overdue';\n  } else if (daysUntilPayment <= 7) {\n    paymentStatus = 'due_soon';\n  } else {\n    paymentStatus = 'paid';\n  }\n} else {\n  paymentStatus = 'unpaid';\n  isOverdue = true;\n}\n\n// Formatar histÃ³rico de pagamentos\nconst paymentHistory = payments.map(p => ({\n  id: p.payment_id,\n  amount: Number(p.amount_paid || 0),\n  status: p.status,\n  method: p.payment_method || 'pix',\n  date: p.payment_date || p.created_at,\n  description: p.description || 'Pagamento'\n}));\n\n// Calcular totais\nconst totalPaid = paymentHistory\n  .filter(p => p.status === 'approved')\n  .reduce((sum, p) => sum + p.amount, 0);\n\nout.push({\n  json: {\n    success: true,\n    client: {\n      siteSlug: clientData.site_slug,\n      email: clientData.email,\n      name: clientData.name,\n      plan: clientData.plan,\n      status: clientData.status\n    },\n    payment: {\n      lastPayment: lastApprovedPayment ? {\n        id: lastApprovedPayment.payment_id,\n        amount: Number(lastApprovedPayment.amount_paid || 0),\n        date: lastApprovedPayment.payment_date,\n        method: lastApprovedPayment.payment_method || 'pix',\n        status: lastApprovedPayment.status\n      } : null,\n      nextPayment: nextPayment ? nextPayment.toISOString() : null,\n      daysUntilPayment: daysUntilPayment,\n      isOverdue: isOverdue,\n      paymentStatus: paymentStatus,\n      totalPaid: totalPaid,\n      totalPayments: paymentHistory.length\n    },\n    history: paymentHistory,\n    timestamp: new Date().toISOString()\n  }\n});\n\nreturn out;"
      },
      "id": "format-info",
      "name": "ğŸ“Š Code - Format Payment Info",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [480, 300]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {
          "responseCode": "={{ $json.code || 200 }}"
        }
      },
      "id": "respond-info",
      "name": "ğŸ“¤ Respond - Payment Info",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [720, 300]
    }
  ],
  "connections": {
    "ğŸ’° Webhook - Get Payment Info": {
      "main": [[{"node": "ğŸ” PostgreSQL - Find Client", "type": "main", "index": 0}]]
    },
    "ğŸ” PostgreSQL - Find Client": {
      "main": [[{"node": "ğŸ’° PostgreSQL - Get Payments", "type": "main", "index": 0}]]
    },
    "ğŸ’° PostgreSQL - Get Payments": {
      "main": [[{"node": "ğŸ“Š Code - Format Payment Info", "type": "main", "index": 0}]]
    },
    "ğŸ“Š Code - Format Payment Info": {
      "main": [[{"node": "ğŸ“¤ Respond - Payment Info", "type": "main", "index": 0}]]
    }
  }
}







