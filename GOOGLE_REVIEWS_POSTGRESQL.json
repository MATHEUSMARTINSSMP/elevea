{
  "name": "Google Reviews - PostgreSQL",
  "nodes": [
    {
      "parameters": {
        "path": "api/google/reviews/fetch",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-fetch",
      "name": "ğŸ” Webhook - Reviews Fetch",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [736, 1488],
      "webhookId": "google-reviews-fetch"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "api/google/reviews/save",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-save",
      "name": "ğŸ’¾ Webhook - Reviews Save",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [736, 1776],
      "webhookId": "google-reviews-save"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "api/google/reviews/respond",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-respond",
      "name": "ğŸ’¬ Webhook - Reviews Respond",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [736, 2080],
      "webhookId": "google-reviews-respond"
    },
    {
      "parameters": {
        "path": "api/google/reviews/stats",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-stats",
      "name": "ğŸ“Š Webhook - Reviews Stats",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [736, 2384],
      "webhookId": "google-reviews-stats"
    },
    {
      "parameters": {
        "jsCode": "// Normalize Fetch Reviews (MELHORADO - Multi-tenant)\nconst now = () => new Date().toISOString();\nconst trim = v => typeof v === 'string' ? v.trim() : v;\nconst low = v => typeof v === 'string' ? v.toLowerCase() : v;\n\nconst out = [];\nfor (const {json} of items) {\n  const headers = Object.fromEntries(Object.entries(json.headers || {}).map(([k, v]) => [k.toLowerCase(), v]));\n  const method = (json.req?.method || json.method || '').toUpperCase();\n  \n  // Handle CORS preflight\n  if (method === 'OPTIONS' || headers['access-control-request-method']) {\n    out.push({json: {_preflight: true}});\n    continue;\n  }\n  \n  const q = json.query || {};\n  const customerId = trim(q.customerId || '');\n  const siteSlug = low(trim(q.siteSlug || ''));\n  const accountId = trim(q.accountId || '');\n  const locationId = trim(q.locationId || '');\n  const limit = Math.min(Math.max(parseInt(q.limit) || 50, 1), 200);\n  const pageToken = trim(q.pageToken || '');\n  \n  if (!customerId || !siteSlug || !accountId || !locationId) {\n    out.push({\n      json: {\n        success: false,\n        error: 'customerId, siteSlug, accountId e locationId sÃ£o obrigatÃ³rios',\n        statusCode: 400,\n        timestamp: now(),\n        _preflight: false\n      }\n    });\n    continue;\n  }\n  \n  out.push({\n    json: {\n      customerId,\n      siteSlug,\n      accountId,\n      locationId,\n      limit,\n      pageToken,\n      _preflight: false\n    }\n  });\n}\nreturn out;"
      },
      "id": "code-fetch-normalize",
      "name": "ğŸ” Code - Fetch Normalize",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [944, 1488]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT customer_id, site_slug, access_token, refresh_token, expires_at, scopes, status, token_type FROM elevea.google_credentials WHERE customer_id = $1 AND site_slug = $2 AND status = 'active' LIMIT 1",
        "options": {
          "queryReplacement": "$1 â†’ {{$json.customerId}}\n$2 â†’ {{$json.siteSlug}}"
        }
      },
      "id": "postgres-load-token",
      "name": "ğŸ—„ï¸ PostgreSQL - Load Token",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [1184, 1488],
      "credentials": {
        "postgres": {
          "id": "S2Hp22T5AgilJMEy",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Token Check (MELHORADO - Corrigido para lidar com refresh_token ausente)\nconst inputData = $input.all();\n\nif (inputData.length === 0) {\n  return [{\n    json: {\n      success: false,\n      error: 'Credenciais nÃ£o encontradas',\n      needRefresh: false,\n      needsReauth: false\n    }\n  }];\n}\n\nconst row = inputData[0].json || {};\nconst access_token = row.access_token || '';\nconst refresh_token = (row.refresh_token || '').trim();\nconst expires_at = row.expires_at ? new Date(row.expires_at).getTime() : null;\nconst now = Date.now();\n\n// Verificar se precisa refresh APENAS se tiver refresh_token disponÃ­vel\n// Se nÃ£o tiver refresh_token, nÃ£o pode fazer refresh (precisa re-autenticar)\nconst hasRefreshToken = refresh_token.length > 0;\nconst isExpired = expires_at ? now > (expires_at - 300000) : false; // 5 min antes\nconst needRefresh = hasRefreshToken && (!access_token || isExpired);\nconst needsReauth = !hasRefreshToken && (!access_token || isExpired);\n\nreturn [{\n  json: {\n    customer_id: row.customer_id,\n    site_slug: row.site_slug,\n    access_token: access_token,\n    refresh_token: refresh_token,\n    expires_at: expires_at ? new Date(expires_at).toISOString() : null,\n    scopes: row.scopes || '',\n    status: row.status || 'active',\n    token_type: row.token_type || 'Bearer',\n    needRefresh: needRefresh,\n    needsReauth: needsReauth\n  }\n}];"
      },
      "id": "code-token-check",
      "name": "ğŸ§ª Code - Token Check",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1408, 1488]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.needRefresh }}",
              "value2": true
            }
          ]
        }
      },
      "id": "if-needs-refresh",
      "name": "IF - Needs Refresh",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1632, 1488]
    },
    {
      "parameters": {
        "jsCode": "// Prepare Token Refresh (MELHORADO - ValidaÃ§Ã£o melhorada)\nconst inputData = $input.all();\n\nif (inputData.length === 0) {\n  return [{\n    json: {\n      success: false,\n      error: 'Dados de token nÃ£o encontrados',\n      needsReauth: true\n    }\n  }];\n}\n\nconst tokenData = inputData[0].json || {};\nconst refresh_token = (tokenData.refresh_token || '').trim();\n\n// Validar refresh_token antes de tentar usar\nif (!refresh_token || refresh_token.length === 0) {\n  return [{\n    json: {\n      success: false,\n      error: 'refresh_token nÃ£o disponÃ­vel. Ã‰ necessÃ¡rio re-autenticar com o Google.',\n      needsReauth: true,\n      customer_id: tokenData.customer_id,\n      site_slug: tokenData.site_slug\n    }\n  }];\n}\n\n// Config OAuth\nconst oauth = {\n  token_url: 'https://oauth2.googleapis.com/token',\n  client_id: process.env.GOOGLE_OAUTH_CLIENT_ID || 'CONFIGURE_NO_N8N',\n  client_secret: process.env.GOOGLE_OAUTH_CLIENT_SECRET || 'CONFIGURE_NO_N8N'\n};\n\nreturn [{\n  json: {\n    url: oauth.token_url,\n    body: {\n      client_id: oauth.client_id,\n      client_secret: oauth.client_secret,\n      refresh_token: refresh_token,\n      grant_type: 'refresh_token'\n    },\n    // Preservar dados originais\n    customer_id: tokenData.customer_id,\n    site_slug: tokenData.site_slug,\n    refresh_token: refresh_token,\n    needsReauth: false\n  }\n}];"
      },
      "id": "code-prepare-refresh",
      "name": "ğŸ”§ Code - Prepare Refresh",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1856, 1440]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $json.url }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/x-www-form-urlencoded"
            },
            {
              "name": "Accept",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "form-urlencoded",
        "bodyParameters": {
          "parameters": [
            {
              "name": "client_id",
              "value": "={{ $json.body.client_id }}"
            },
            {
              "name": "client_secret",
              "value": "={{ $json.body.client_secret }}"
            },
            {
              "name": "refresh_token",
              "value": "={{ $json.body.refresh_token }}"
            },
            {
              "name": "grant_type",
              "value": "={{ $json.body.grant_type }}"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "fullResponse": true,
              "responseFormat": "json"
            }
          }
        }
      },
      "id": "http-token-refresh",
      "name": "ğŸŒ HTTP - Token Refresh",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2080, 1440]
    },
    {
      "parameters": {
        "jsCode": "// Process Token Refresh Response (MELHORADO)\nconst inputData = $input.all();\n\nif (inputData.length === 0) {\n  return [{\n    json: {\n      success: false,\n      error: 'Nenhuma resposta HTTP recebida'\n    }\n  }];\n}\n\nconst httpResponse = inputData[0].json || {};\nconst httpStatus = inputData[0].statusCode || null;\n\n// Verificar erro\nif (httpResponse.error || httpResponse.body?.error) {\n  const error = httpResponse.error || httpResponse.body?.error;\n  return [{\n    json: {\n      success: false,\n      error: error,\n      error_description: httpResponse.error_description || httpResponse.body?.error_description,\n      http_status: httpStatus\n    }\n  }];\n}\n\n// Extrair tokens (pode estar em body ou root)\nconst responseBody = httpResponse.body || httpResponse;\nconst access_token = responseBody.access_token || '';\nconst expires_in = Number(responseBody.expires_in || 3600);\nconst refresh_token = responseBody.refresh_token || '';\n\nif (!access_token) {\n  return [{\n    json: {\n      success: false,\n      error: 'access_token nÃ£o encontrado na resposta',\n      http_status: httpStatus,\n      debug_response: httpResponse\n    }\n  }];\n}\n\n// Buscar dados preservados\nlet customer_id = '';\nlet site_slug = '';\nlet original_refresh_token = '';\n\ntry {\n  const prepareData = $('ğŸ”§ Code - Prepare Refresh').all();\n  if (prepareData && prepareData.length > 0) {\n    customer_id = prepareData[0].json?.customer_id || '';\n    site_slug = prepareData[0].json?.site_slug || '';\n    original_refresh_token = prepareData[0].json?.refresh_token || '';\n  }\n} catch (e) {\n  console.log('Erro ao buscar dados preservados:', e.message);\n}\n\n// Calcular expires_at\nconst expires_at = Date.now() + (expires_in * 1000);\n\nreturn [{\n  json: {\n    success: true,\n    access_token: access_token,\n    refresh_token: refresh_token || original_refresh_token,\n    expires_at: expires_at,\n    expires_in: expires_in,\n    customer_id: customer_id,\n    site_slug: site_slug\n  }\n}];"
      },
      "id": "code-process-refresh",
      "name": "ğŸ”„ Code - Process Refresh",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2304, 1440]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE elevea.google_credentials SET access_token = $1, refresh_token = COALESCE($2, refresh_token), expires_at = TO_TIMESTAMP($3 / 1000), updated_at = NOW() WHERE customer_id = $4 AND site_slug = $5 RETURNING customer_id, site_slug, access_token, expires_at",
        "options": {
          "queryReplacement": "$1 â†’ {{$json.access_token}}\n$2 â†’ {{$json.refresh_token || ''}}\n$3 â†’ {{$json.expires_at}}\n$4 â†’ {{$json.customer_id}}\n$5 â†’ {{$json.site_slug}}"
        }
      },
      "id": "postgres-token-update",
      "name": "ğŸ—„ï¸ PostgreSQL - Token Update",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [2528, 1440],
      "credentials": {
        "postgres": {
          "id": "S2Hp22T5AgilJMEy",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Merge Token (MELHORADO - Tratamento de erros)\nconst inputData = $input.all();\n\nif (inputData.length === 0) {\n  return [{\n    json: {\n      success: false,\n      error: 'Nenhum dado recebido'\n    }\n  }];\n}\n\n// Verificar se hÃ¡ erro no input (ex: refresh_token nÃ£o disponÃ­vel)\nconst firstItem = inputData[0].json || {};\nif (firstItem.success === false || firstItem.error) {\n  return [{\n    json: {\n      success: false,\n      error: firstItem.error || 'Erro ao processar token',\n      needsReauth: firstItem.needsReauth || false\n    }\n  }];\n}\n\n// Se veio do IF False (nÃ£o precisa refresh), usar dados originais\nconst tokenCheck = $('ğŸ§ª Code - Token Check').all();\nif (tokenCheck && tokenCheck.length > 0 && !tokenCheck[0].json?.needRefresh) {\n  const tokenData = tokenCheck[0].json || {};\n  return [{\n    json: {\n      access_token: tokenData.access_token || '',\n      expires_at: tokenData.expires_at,\n      refresh_token: tokenData.refresh_token || ''\n    }\n  }];\n}\n\n// Se veio do PostgreSQL Update (refresh feito), usar dados atualizados\nconst updatedData = inputData[0].json || {};\nif (updatedData.access_token) {\n  return [{\n    json: {\n      access_token: updatedData.access_token,\n      expires_at: updatedData.expires_at ? new Date(updatedData.expires_at).getTime() : null,\n      refresh_token: updatedData.refresh_token || tokenCheck?.[0]?.json?.refresh_token || ''\n    }\n  }];\n}\n\n// Fallback\nreturn [{\n  json: {\n    success: false,\n    error: 'NÃ£o foi possÃ­vel obter access_token'\n  }\n}];"
      },
      "id": "code-token-merge",
      "name": "ğŸª„ Code - Token Merge",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2752, 1488]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "={{ 'https://mybusiness.googleapis.com/v4/accounts/' + $('ğŸ” Code - Fetch Normalize').item.json.accountId + '/locations/' + $('ğŸ” Code - Fetch Normalize').item.json.locationId + '/reviews' }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{ 'Bearer ' + $json.access_token }}"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "fullResponse": true,
              "responseFormat": "json"
            }
          }
        }
      },
      "id": "http-gbp-reviews-list",
      "name": "ğŸŒ HTTP - GBP Reviews List",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2976, 1488]
    },
    {
      "parameters": {
        "jsCode": "// Format Fetch Output (MELHORADO)\nconst inputData = $input.all();\n\nif (inputData.length === 0) {\n  return [{\n    json: {\n      success: false,\n      error: 'Nenhuma resposta recebida',\n      count: 0,\n      reviews: []\n    }\n  }];\n}\n\nconst httpResponse = inputData[0].json || {};\nconst responseBody = httpResponse.body || httpResponse;\n\n// Verificar erro\nif (responseBody.error || httpResponse.statusCode >= 400) {\n  return [{\n    json: {\n      success: false,\n      error: responseBody.error?.message || responseBody.error || 'Erro ao buscar reviews',\n      http_status: httpResponse.statusCode,\n      count: 0,\n      reviews: []\n    }\n  }];\n}\n\n// Extrair reviews\nconst reviewsArray = Array.isArray(responseBody.reviews) \n  ? responseBody.reviews \n  : (responseBody.reviews?.reviews || []);\n\nconst itemsOut = reviewsArray.map(r => {\n  const reviewId = r.reviewId || r.name?.split('/').pop() || '';\n  return {\n    reviewId: reviewId,\n    rating: r.starRating || r.rating || r.ratingValue || 0,\n    comment: r.comment || r.reviewComment || r.text || '',\n    reviewer: r.reviewer?.displayName || r.reviewer || '',\n    createTime: r.createTime || r.updateTime || r.reviewTime || null,\n    reply: r.reviewReply?.comment || r.reply || ''\n  };\n});\n\nreturn [{\n  json: {\n    success: true,\n    count: itemsOut.length,\n    reviews: itemsOut,\n    nextPageToken: responseBody.nextPageToken || null\n  }\n}];"
      },
      "id": "code-format-fetch-output",
      "name": "ğŸ§¾ Code - Format Fetch Output",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [3200, 1488]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              }
            ]
          }
        }
      },
      "id": "respond-fetch",
      "name": "ğŸ“¤ Respond - Fetch",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [3424, 1488]
    },
    {
      "parameters": {
        "jsCode": "// Normalize Save (MELHORADO - Multi-tenant)\nconst now = () => new Date().toISOString();\nconst trim = v => typeof v === 'string' ? v.trim() : v;\nconst low = v => typeof v === 'string' ? v.toLowerCase() : v;\n\nconst out = [];\nfor (const {json} of items) {\n  const headers = Object.fromEntries(Object.entries(json.headers || {}).map(([k, v]) => [k.toLowerCase(), v]));\n  const method = (json.req?.method || json.method || '').toUpperCase();\n  \n  // Handle CORS preflight\n  if (method === 'OPTIONS' || headers['access-control-request-method']) {\n    out.push({json: {_preflight: true}});\n    continue;\n  }\n  \n  let b = json.body || {};\n  if (typeof b === 'string') {\n    try {\n      b = JSON.parse(b);\n    } catch {\n      b = {};\n    }\n  }\n  \n  const siteSlug = low(trim(b.siteSlug || b.site_slug || ''));\n  const customerId = trim(b.customerId || b.customer_id || '');\n  const reviews = Array.isArray(b.reviews) ? b.reviews : [];\n  \n  if (!siteSlug || !customerId || !reviews.length) {\n    out.push({\n      json: {\n        success: false,\n        error: 'siteSlug, customerId e reviews[] sÃ£o obrigatÃ³rios',\n        statusCode: 400,\n        timestamp: now(),\n        _preflight: false\n      }\n    });\n    continue;\n  }\n  \n  // Processar cada review\n  for (const r of reviews) {\n    out.push({\n      json: {\n        site_slug: siteSlug,\n        customer_id: customerId,\n        review_id_external: trim(r.reviewId || r.id || ''),\n        rating: Math.max(0, Math.min(5, Number(r.rating) || 0)),\n        comment: trim(r.comment || '').slice(0, 2000),\n        author_name: trim(r.reviewer || r.author || '').slice(0, 200),\n        review_date: r.createTime || r.review_date || now(),\n        reply: trim(r.reply || '').slice(0, 2000),\n        synced_at: now()\n      }\n    });\n  }\n}\nreturn out;"
      },
      "id": "code-save-normalize",
      "name": "ğŸ’¾ Code - Save Normalize",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [944, 1776]
    },
    {
      "parameters": {
        "jsCode": "// Prepare PostgreSQL Params (GARANTE TODOS OS CAMPOS)\nconst now = () => new Date().toISOString();\nconst out = [];\n\nfor (const item of $input.all()) {\n  const data = item.json || {};\n  \n  // Garantir que todos os campos existam com valores padrÃ£o\n  const params = {\n    p1: data.customer_id || '',\n    p2: data.site_slug || '',\n    p3: data.review_id_external || '',\n    p4: Math.max(0, Math.min(5, Number(data.rating) || 0)),\n    p5: (data.comment || '').slice(0, 2000),\n    p6: (data.author_name || '').slice(0, 200),\n    p7: data.review_date || now(),\n    p8: (data.reply || '').slice(0, 2000),\n    p9: data.synced_at || now()\n  };\n  \n  out.push({\n    json: {\n      customer_id: params.p1,\n      site_slug: params.p2,\n      review_id_external: params.p3,\n      rating: params.p4,\n      comment: params.p5,\n      author_name: params.p6,\n      review_date: params.p7,\n      reply: params.p8,\n      synced_at: params.p9\n    }\n  });\n}\n\nreturn out;"
      },
      "id": "code-prepare-postgres",
      "name": "ğŸ”§ Code - Prepare PostgreSQL",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1080, 1776]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO elevea.google_reviews (customer_id, site_slug, review_id_external, rating, comment, author_name, review_date, reply, synced_at) VALUES ($1, $2, $3, $4, $5, $6, $7, COALESCE($8, ''), $9) ON CONFLICT (customer_id, site_slug, review_id_external) DO UPDATE SET rating = EXCLUDED.rating, comment = EXCLUDED.comment, author_name = EXCLUDED.author_name, review_date = EXCLUDED.review_date, reply = EXCLUDED.reply, synced_at = EXCLUDED.synced_at, updated_at = NOW() RETURNING review_id",
        "options": {
          "queryReplacement": "$1 -> {{$json.customer_id}}\n$2 -> {{$json.site_slug}}\n$3 -> {{$json.review_id_external}}\n$4 -> {{$json.rating}}\n$5 -> {{$json.comment}}\n$6 -> {{$json.author_name}}\n$7 -> {{$json.review_date}}\n$8 -> {{$json.reply}}\n$9 -> {{$json.synced_at}}"
        }
      },
      "id": "postgres-reviews-create",
      "name": "ğŸ—„ï¸ PostgreSQL - Reviews Create",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [1280, 1776],
      "credentials": {
        "postgres": {
          "id": "S2Hp22T5AgilJMEy",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Save Output\nconst inputData = $input.all();\nconst count = inputData.filter(item => item.json && (item.json.review_id || item.json.review_id_external)).length;\n\nreturn [{\n  json: {\n    success: true,\n    message: 'Reviews salvos com sucesso',\n    count: count\n  }\n}];"
      },
      "id": "code-save-out",
      "name": "ğŸ’¾ Code - Save Out",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1408, 1776]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              }
            ]
          }
        }
      },
      "id": "respond-save",
      "name": "ğŸ“¤ Respond - Save",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1632, 1776]
    },
    {
      "parameters": {
        "jsCode": "// Normalize Respond (MELHORADO - Multi-tenant)\nconst now = () => new Date().toISOString();\nconst trim = v => typeof v === 'string' ? v.trim() : v;\nconst low = v => typeof v === 'string' ? v.toLowerCase() : v;\n\nconst out = [];\nfor (const {json} of items) {\n  const headers = Object.fromEntries(Object.entries(json.headers || {}).map(([k, v]) => [k.toLowerCase(), v]));\n  const method = (json.req?.method || json.method || '').toUpperCase();\n  \n  // Handle CORS preflight\n  if (method === 'OPTIONS' || headers['access-control-request-method']) {\n    out.push({json: {_preflight: true}});\n    continue;\n  }\n  \n  let b = json.body || {};\n  if (typeof b === 'string') {\n    try {\n      b = JSON.parse(b);\n    } catch {\n      b = {};\n    }\n  }\n  \n  const customerId = trim(b.customerId || b.customer_id || '');\n  const siteSlug = low(trim(b.siteSlug || b.site_slug || ''));\n  const accountId = trim(b.accountId || b.account_id || '');\n  const locationId = trim(b.locationId || b.location_id || '');\n  const reviewId = trim(b.reviewId || b.review_id || '');\n  const reply = trim(b.reply || '');\n  \n  if (!customerId || !siteSlug || !accountId || !locationId || !reviewId || !reply) {\n    out.push({\n      json: {\n        success: false,\n        error: 'customerId, siteSlug, accountId, locationId, reviewId e reply sÃ£o obrigatÃ³rios',\n        statusCode: 400,\n        timestamp: now(),\n        _preflight: false\n      }\n    });\n    continue;\n  }\n  \n  out.push({\n    json: {\n      customerId,\n      siteSlug,\n      accountId,\n      locationId,\n      reviewId,\n      reply,\n      _preflight: false\n    }\n  });\n}\nreturn out;"
      },
      "id": "code-respond-normalize",
      "name": "ğŸ’¬ Code - Respond Normalize",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [944, 2080]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT customer_id, site_slug, access_token, refresh_token, expires_at FROM elevea.google_credentials WHERE customer_id = $1 AND site_slug = $2 AND status = 'active' LIMIT 1",
        "options": {
          "queryReplacement": "$1 â†’ {{$json.customerId}}\n$2 â†’ {{$json.siteSlug}}"
        }
      },
      "id": "postgres-load-token-respond",
      "name": "ğŸ—„ï¸ PostgreSQL - Load Token (Respond)",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [1184, 2080],
      "credentials": {
        "postgres": {
          "id": "S2Hp22T5AgilJMEy",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Prepare Reply Request (MELHORADO)\nconst inputData = $input.all();\n\nif (inputData.length === 0) {\n  return [{\n    json: {\n      success: false,\n      error: 'Credenciais nÃ£o encontradas'\n    }\n  }];\n}\n\nconst tokenData = inputData[0].json || {};\nconst access_token = tokenData.access_token || '';\n\nif (!access_token) {\n  return [{\n    json: {\n      success: false,\n      error: 'access_token nÃ£o encontrado'\n    }\n  }];\n}\n\n// Buscar dados do normalize\nconst normalizeData = $('ğŸ’¬ Code - Respond Normalize').all();\nconst normalize = normalizeData && normalizeData.length > 0 ? normalizeData[0].json : {};\n\nconst accountId = normalize.accountId || '';\nconst locationId = normalize.locationId || '';\nconst reviewId = normalize.reviewId || '';\nconst reply = normalize.reply || '';\n\nif (!accountId || !locationId || !reviewId || !reply) {\n  return [{\n    json: {\n      success: false,\n      error: 'accountId, locationId, reviewId e reply sÃ£o obrigatÃ³rios'\n    }\n  }];\n}\n\nreturn [{\n  json: {\n    url: `https://mybusiness.googleapis.com/v4/accounts/${accountId}/locations/${locationId}/reviews/${reviewId}:reply`,\n    access_token: access_token,\n    reply: reply\n  }\n}];"
      },
      "id": "code-prepare-reply",
      "name": "ğŸ”§ Code - Prepare Reply",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1408, 2080]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $json.url }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{ 'Bearer ' + $json.access_token }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "json",
        "body": "={{ { comment: $json.reply } }}",
        "options": {
          "response": {
            "response": {
              "fullResponse": true,
              "responseFormat": "json"
            }
          }
        }
      },
      "id": "http-gbp-reply",
      "name": "ğŸŒ HTTP - GBP Reply",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1632, 2080]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { success: true, replied: true } }}",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              }
            ]
          }
        }
      },
      "id": "respond-respond",
      "name": "ğŸ“¤ Respond - Respond",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1856, 2080]
    },
    {
      "parameters": {
        "jsCode": "// Normalize Stats (MELHORADO - Multi-tenant)\nconst now = () => new Date().toISOString();\nconst trim = v => typeof v === 'string' ? v.trim() : v;\nconst low = v => typeof v === 'string' ? v.toLowerCase() : v;\n\nconst out = [];\nfor (const {json} of items) {\n  const headers = Object.fromEntries(Object.entries(json.headers || {}).map(([k, v]) => [k.toLowerCase(), v]));\n  const method = (json.req?.method || json.method || '').toUpperCase();\n  \n  // Handle CORS preflight\n  if (method === 'OPTIONS' || headers['access-control-request-method']) {\n    out.push({json: {_preflight: true}});\n    continue;\n  }\n  \n  const q = json.query || {};\n  const siteSlug = low(trim(q.siteSlug || ''));\n  const customerId = trim(q.customerId || '');\n  const period = trim(q.period || '30d');\n  \n  if (!siteSlug) {\n    out.push({\n      json: {\n        success: false,\n        error: 'siteSlug Ã© obrigatÃ³rio',\n        statusCode: 400,\n        timestamp: now(),\n        _preflight: false\n      }\n    });\n    continue;\n  }\n  \n  // Calcular data inicial baseado no perÃ­odo\n  const nowD = new Date();\n  let fromDate = '1900-01-01';\n  \n  if (period === '7d') {\n    fromDate = new Date(nowD - 7 * 86400000).toISOString().slice(0, 10);\n  } else if (period === '30d') {\n    fromDate = new Date(nowD - 30 * 86400000).toISOString().slice(0, 10);\n  } else if (period === '90d') {\n    fromDate = new Date(nowD - 90 * 86400000).toISOString().slice(0, 10);\n  } else if (period === '1y') {\n    fromDate = new Date(nowD - 365 * 86400000).toISOString().slice(0, 10);\n  }\n  \n  out.push({\n    json: {\n      siteSlug,\n      customerId,\n      period,\n      fromDate,\n      _preflight: false\n    }\n  });\n}\nreturn out;"
      },
      "id": "code-stats-normalize",
      "name": "ğŸ“Š Code - Stats Normalize",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [944, 2384]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT rating, reply FROM elevea.google_reviews WHERE site_slug = $1 AND ($2 IS NULL OR customer_id = $2) AND review_date >= $3::date ORDER BY review_date DESC",
        "options": {
          "queryReplacement": "$1 â†’ {{$json.siteSlug}}\n$2 â†’ {{$json.customerId || null}}\n$3 â†’ {{$json.fromDate}}"
        }
      },
      "id": "postgres-stats-search",
      "name": "ğŸ—„ï¸ PostgreSQL - Stats Search",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [1184, 2384],
      "credentials": {
        "postgres": {
          "id": "S2Hp22T5AgilJMEy",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Calculate Stats (MELHORADO)\nconst inputData = $input.all();\n\nif (inputData.length === 0) {\n  return [{\n    json: {\n      success: true,\n      totalReviews: 0,\n      averageRating: 0,\n      ratingDistribution: {1: 0, 2: 0, 3: 0, 4: 0, 5: 0},\n      responseRate: 0,\n      repliedReviews: 0,\n      period: '30d'\n    }\n  }];\n}\n\nconst reviews = inputData.map(item => item.json);\nconst count = reviews.length;\n\nif (count === 0) {\n  return [{\n    json: {\n      success: true,\n      totalReviews: 0,\n      averageRating: 0,\n      ratingDistribution: {1: 0, 2: 0, 3: 0, 4: 0, 5: 0},\n      responseRate: 0,\n      repliedReviews: 0,\n      period: $('ğŸ“Š Code - Stats Normalize').item.json.period || '30d'\n    }\n  }];\n}\n\n// Calcular mÃ©dia\nconst sum = reviews.reduce((acc, r) => acc + Number(r.rating || 0), 0);\nconst avg = count > 0 ? Number((sum / count).toFixed(2)) : 0;\n\n// DistribuiÃ§Ã£o de ratings\nconst dist = {1: 0, 2: 0, 3: 0, 4: 0, 5: 0};\nreviews.forEach(r => {\n  const v = Number(r.rating || 0);\n  if (dist[v] !== undefined) dist[v]++;\n});\n\n// Reviews com resposta\nconst replied = reviews.filter(r => (r.reply || '').trim()).length;\nconst responseRate = count > 0 ? Number(((replied / count) * 100).toFixed(2)) : 0;\n\nreturn [{\n  json: {\n    success: true,\n    totalReviews: count,\n    averageRating: avg,\n    ratingDistribution: dist,\n    responseRate: responseRate,\n    repliedReviews: replied,\n    period: $('ğŸ“Š Code - Stats Normalize').item.json.period || '30d'\n  }\n}];"
      },
      "id": "code-stats-out",
      "name": "ğŸ“ˆ Code - Stats Out",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1408, 2384]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              }
            ]
          }
        }
      },
      "id": "respond-stats",
      "name": "ğŸ“¤ Respond - Stats",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1632, 2384]
    }
  ],
  "connections": {
    "ğŸ” Webhook - Reviews Fetch": {
      "main": [[{"node": "ğŸ” Code - Fetch Normalize", "type": "main", "index": 0}]]
    },
    "ğŸ’¾ Webhook - Reviews Save": {
      "main": [[{"node": "ğŸ’¾ Code - Save Normalize", "type": "main", "index": 0}]]
    },
    "ğŸ’¬ Webhook - Reviews Respond": {
      "main": [[{"node": "ğŸ’¬ Code - Respond Normalize", "type": "main", "index": 0}]]
    },
    "ğŸ“Š Webhook - Reviews Stats": {
      "main": [[{"node": "ğŸ“Š Code - Stats Normalize", "type": "main", "index": 0}]]
    },
    "ğŸ” Code - Fetch Normalize": {
      "main": [[{"node": "ğŸ—„ï¸ PostgreSQL - Load Token", "type": "main", "index": 0}]]
    },
    "ğŸ—„ï¸ PostgreSQL - Load Token": {
      "main": [[{"node": "ğŸ§ª Code - Token Check", "type": "main", "index": 0}]]
    },
    "ğŸ§ª Code - Token Check": {
      "main": [[{"node": "IF - Needs Refresh", "type": "main", "index": 0}]]
    },
    "IF - Needs Refresh": {
      "main": [
        [{"node": "ğŸ”§ Code - Prepare Refresh", "type": "main", "index": 0}],
        [{"node": "ğŸª„ Code - Token Merge", "type": "main", "index": 0}]
      ]
    },
    "ğŸ”§ Code - Prepare Refresh": {
      "main": [[{"node": "ğŸŒ HTTP - Token Refresh", "type": "main", "index": 0}]]
    },
    "ğŸŒ HTTP - Token Refresh": {
      "main": [[{"node": "ğŸ”„ Code - Process Refresh", "type": "main", "index": 0}]]
    },
    "ğŸ”„ Code - Process Refresh": {
      "main": [[{"node": "ğŸ—„ï¸ PostgreSQL - Token Update", "type": "main", "index": 0}]]
    },
    "ğŸ—„ï¸ PostgreSQL - Token Update": {
      "main": [[{"node": "ğŸª„ Code - Token Merge", "type": "main", "index": 0}]]
    },
    "ğŸª„ Code - Token Merge": {
      "main": [[{"node": "ğŸŒ HTTP - GBP Reviews List", "type": "main", "index": 0}]]
    },
    "ğŸŒ HTTP - GBP Reviews List": {
      "main": [[{"node": "ğŸ§¾ Code - Format Fetch Output", "type": "main", "index": 0}]]
    },
    "ğŸ§¾ Code - Format Fetch Output": {
      "main": [[{"node": "ğŸ“¤ Respond - Fetch", "type": "main", "index": 0}]]
    },
    "ğŸ’¾ Code - Save Normalize": {
      "main": [[{"node": "ğŸ”§ Code - Prepare PostgreSQL", "type": "main", "index": 0}]]
    },
    "ğŸ”§ Code - Prepare PostgreSQL": {
      "main": [[{"node": "ğŸ—„ï¸ PostgreSQL - Reviews Create", "type": "main", "index": 0}]]
    },
    "ğŸ—„ï¸ PostgreSQL - Reviews Create": {
      "main": [[{"node": "ğŸ’¾ Code - Save Out", "type": "main", "index": 0}]]
    },
    "ğŸ’¾ Code - Save Out": {
      "main": [[{"node": "ğŸ“¤ Respond - Save", "type": "main", "index": 0}]]
    },
    "ğŸ’¬ Code - Respond Normalize": {
      "main": [[{"node": "ğŸ—„ï¸ PostgreSQL - Load Token (Respond)", "type": "main", "index": 0}]]
    },
    "ğŸ—„ï¸ PostgreSQL - Load Token (Respond)": {
      "main": [[{"node": "ğŸ”§ Code - Prepare Reply", "type": "main", "index": 0}]]
    },
    "ğŸ”§ Code - Prepare Reply": {
      "main": [[{"node": "ğŸŒ HTTP - GBP Reply", "type": "main", "index": 0}]]
    },
    "ğŸŒ HTTP - GBP Reply": {
      "main": [[{"node": "ğŸ“¤ Respond - Respond", "type": "main", "index": 0}]]
    },
    "ğŸ“Š Code - Stats Normalize": {
      "main": [[{"node": "ğŸ—„ï¸ PostgreSQL - Stats Search", "type": "main", "index": 0}]]
    },
    "ğŸ—„ï¸ PostgreSQL - Stats Search": {
      "main": [[{"node": "ğŸ“ˆ Code - Stats Out", "type": "main", "index": 0}]]
    },
    "ğŸ“ˆ Code - Stats Out": {
      "main": [[{"node": "ğŸ“¤ Respond - Stats", "type": "main", "index": 0}]]
    }
  },
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "c54d95e1e8c78b0647a47bf20abbc07d803d84dc24a093f032b7c48ff894b672"
  }
}

