{
  "name": "Leads - PostgreSQL",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "api/leads/capture",
        "responseMode": "lastNode",
        "options": {}
      },
      "id": "webhook-capture",
      "name": "ğŸ¯ Webhook - Leads Capture",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [-1024, 144],
      "webhookId": "leads-capture-postgres"
    },
    {
      "parameters": {
        "path": "api/leads/list",
        "responseMode": "lastNode",
        "options": {}
      },
      "id": "webhook-list",
      "name": "ğŸ“‹ Webhook - Leads List",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [-1024, 480],
      "webhookId": "leads-list-postgres"
    },
    {
      "parameters": {
        "jsCode": "// Normalize/validate + CORS preflight\nconst now = () => new Date().toISOString();\nconst trim = v => typeof v === 'string' ? v.trim() : v;\nconst low = v => typeof v === 'string' ? v.toLowerCase() : v;\nconst n = v => (v===''||v==null)?null:Number(v);\nconst valEmail = e => /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(e||'');\nconst valPhone = p => /^[\\d\\s+\\-()]{10,20}$/.test(p||'');\nconst ip = h => (h['x-forwarded-for']||'').split(',')[0].trim() || h['x-real-ip'] || 'unknown';\nconst hash = s=>{let h=0;for(const c of String(s))h=((h<<5)-h)+c.charCodeAt(0),h|=0;return Math.abs(h).toString(36).slice(0,12)};\n\nconst out=[];\nfor (const {json} of items){\n  const headers=Object.fromEntries(Object.entries(json.headers||{}).map(([k,v])=>[k.toLowerCase(),v]));\n  const method=(json.req?.method||json.method||'').toUpperCase();\n  if(method==='OPTIONS'||headers['access-control-request-method']){ out.push({json:{_preflight:true}}); continue; }\n  \n  let b=json.body??{}; if(typeof b==='string'){ try{ b=JSON.parse(b) } catch{ b={} } }\n  const site_slug=low(trim(b.siteSlug||b.site_slug||''));\n  const name=trim(b.name)||'';\n  const email=low(trim(b.email||''));\n  const phone=trim(b.phone||'');\n  const source=trim(b.source)||'website';\n  const message=(trim(b.message)||'').slice(0,2000);\n  const lead_type=trim(b.leadType||b.lead_type)||'general';\n  const priority=n(b.priority)||3;\n  const tags=Array.isArray(b.tags)?b.tags.slice(0,10):[];\n  \n  if(!site_slug||!name||(!email&&!phone)){ out.push({json:{success:false,message:'siteSlug, name e (email ou phone) sÃ£o obrigatÃ³rios',timestamp:now(),statusCode:400}}); continue; }\n  if(email && !valEmail(email)){ out.push({json:{success:false,message:'Email invÃ¡lido',timestamp:now(),statusCode:400}}); continue; }\n  if(phone && !valPhone(phone)){ out.push({json:{success:false,message:'Telefone invÃ¡lido',timestamp:now(),statusCode:400}}); continue; }\n  if(priority<1||priority>5){ out.push({json:{success:false,message:'priority deve ser 1..5',timestamp:now(),statusCode:400}}); continue; }\n  \n  const idemSeed=`${site_slug}|${email||phone}|${name}|${source}`;\n  const idemKey=`lead:idem:${hash(idemSeed)}`;\n  const rateKey=`lead:rate:${site_slug}:${hash(ip(headers))}`;\n  \n  out.push({json:{\n    site_slug,name,email:email||null,phone:phone||null,source,message,lead_type,priority,status:'new',\n    tags:tags.join(', '),\n    ip_address:ip(headers),user_agent:headers['user-agent']||'unknown',referrer:headers.referer||headers.referrer||null,\n    created_at:now(),\n    _redis:{idemKey,rateKey},_preflight:false\n  }});\n}\nreturn out;"
      },
      "id": "code-normalize",
      "name": "ğŸ§¹ Code - Normalize + Validate",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-752, 144]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json._preflight }}",
              "value2": false
            }
          ]
        }
      },
      "id": "if-not-preflight",
      "name": "ğŸ”€ IF - Not Preflight",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [-544, 144]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { ok: true } }}",
        "options": {}
      },
      "id": "respond-cors",
      "name": "ğŸ“¤ Respond - CORS",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [-336, 288]
    },
    {
      "parameters": {
        "jsCode": "// Rate limiting simplificado (sem Redis para teste inicial)\n// TODO: Implementar Redis para produÃ§Ã£o\nconst out = [];\nfor (const { json } of items) {\n  // Por enquanto, sempre permite (rate limit desabilitado para teste)\n  // Em produÃ§Ã£o, usar Redis aqui\n  out.push({\n    json: {\n      ...json,\n      _rateLimitOk: true\n    }\n  });\n}\nreturn out;"
      },
      "id": "code-rate-limit-skip",
      "name": "â­ï¸ Code - Skip Rate Limit (Test)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-336, 144]
    },
    {
      "parameters": {
        "jsCode": "// IdempotÃªncia simplificada (sem Redis para teste inicial)\n// TODO: Implementar Redis para produÃ§Ã£o\n// Por enquanto, sempre permite (idempotÃªncia desabilitada para teste)\n// Em produÃ§Ã£o, verificar Redis aqui\nconst out = [];\nfor (const { json } of items) {\n  out.push({\n    json: {\n      ...json,\n      _isNewRequest: true\n    }\n  });\n}\nreturn out;"
      },
      "id": "code-idempotency-skip",
      "name": "â­ï¸ Code - Skip Idempotency (Test)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-128, 144]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO elevea.leads (site_slug, name, email, phone, source, message, lead_type, priority, status, tags, ip_address, user_agent, referrer, created_at) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14) RETURNING lead_id, site_slug, name, email, phone, status, created_at",
        "options": {
          "queryReplacement": "={{ [$json.site_slug, $json.name, $json.email || null, $json.phone || null, $json.source, $json.message || null, $json.lead_type, $json.priority, $json.status, $json.tags || null, $json.ip_address || null, $json.user_agent || null, $json.referrer || null, $json.created_at] }}"
        }
      },
      "id": "postgres-create-lead",
      "name": "ğŸ—„ï¸ PostgreSQL - Create Lead",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [912, 144],
      "credentials": {
        "postgres": {
          "id": "S2Hp22T5AgilJMEy",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Formatar resposta de captura\n// PostgreSQL retorna dados diretamente como objeto\nconst inputData = $input.all();\n\nif (!inputData || inputData.length === 0) {\n  return [{\n    json: {\n      success: false,\n      message: 'Erro ao criar lead - nenhum dado retornado do PostgreSQL',\n      timestamp: new Date().toISOString()\n    }\n  }];\n}\n\n// Processar dados do PostgreSQL\nlet lead = null;\nconst firstItem = inputData[0];\n\nif (firstItem.json) {\n  // PostgreSQL pode retornar diretamente ou dentro de .rows\n  if (firstItem.json.rows && Array.isArray(firstItem.json.rows) && firstItem.json.rows.length > 0) {\n    lead = firstItem.json.rows[0];\n  } else if (firstItem.json.lead_id) {\n    lead = firstItem.json;\n  } else if (Array.isArray(firstItem.json) && firstItem.json.length > 0) {\n    lead = firstItem.json[0];\n  }\n}\n\nif (!lead || !lead.lead_id) {\n  return [{\n    json: {\n      success: false,\n      message: 'Erro ao criar lead - lead_id nÃ£o encontrado',\n      debug: {\n        inputLength: inputData.length,\n        firstItem: firstItem.json,\n        hasRows: !!firstItem.json?.rows\n      },\n      timestamp: new Date().toISOString()\n    }\n  }];\n}\n\nreturn [{\n  json: {\n    success: true,\n    message: 'Lead capturado',\n    data: {\n      id: lead.lead_id,\n      name: lead.name,\n      email: lead.email,\n      phone: lead.phone,\n      siteSlug: lead.site_slug,\n      status: lead.status || 'new',\n      createdAt: lead.created_at\n    },\n    timestamp: new Date().toISOString()\n  }\n}];"
      },
      "id": "code-format-capture",
      "name": "ğŸ¯ Code - Format Capture Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1120, 144]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {}
      },
      "id": "respond-capture",
      "name": "ğŸ“¤ Respond - Capture",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [1328, 144]
    },
    {
      "parameters": {
        "jsCode": "// Build List Filter para PostgreSQL\nconst out = [];\nfor (const { json } of items) {\n  const q = json.query || {};\n  \n  // Construir WHERE clause com condiÃ§Ãµes\n  const conditions = [];\n  const params = [];\n  let paramIndex = 1;\n  \n  // site_slug filter\n  if (q.siteSlug && q.siteSlug !== 'all') {\n    conditions.push(`site_slug = $${paramIndex}`);\n    params.push(q.siteSlug);\n    paramIndex++;\n  }\n  \n  // status filter (suporta mÃºltiplos valores)\n  if (q.status && q.status !== 'all') {\n    const statusList = q.status.split(',').map(s => s.trim()).filter(Boolean);\n    if (statusList.length === 1) {\n      conditions.push(`status = $${paramIndex}`);\n      params.push(statusList[0]);\n      paramIndex++;\n    } else if (statusList.length > 1) {\n      conditions.push(`status = ANY($${paramIndex})`);\n      params.push(statusList);\n      paramIndex++;\n    }\n  }\n  \n  // source filter\n  if (q.source && q.source !== 'all') {\n    conditions.push(`source = $${paramIndex}`);\n    params.push(q.source);\n    paramIndex++;\n  }\n  \n  // lead_type filter\n  if (q.leadType && q.leadType !== 'all') {\n    conditions.push(`lead_type = $${paramIndex}`);\n    params.push(q.leadType);\n    paramIndex++;\n  }\n  \n  // priority filter\n  if (q.priority && q.priority !== '' && !isNaN(Number(q.priority))) {\n    conditions.push(`priority = $${paramIndex}`);\n    params.push(Number(q.priority));\n    paramIndex++;\n  }\n  \n  // date filters\n  const isDate = (s) => /^\\d{4}-\\d{2}-\\d{2}$/.test(String(s || ''));\n  \n  if (isDate(q.startDate)) {\n    conditions.push(`created_at >= $${paramIndex}::date`);\n    params.push(q.startDate);\n    paramIndex++;\n  }\n  \n  if (isDate(q.endDate)) {\n    conditions.push(`created_at <= $${paramIndex}::date + INTERVAL '1 day'`);\n    params.push(q.endDate);\n    paramIndex++;\n  }\n  \n  // Construir WHERE clause\n  const whereClause = conditions.length > 0 ? `WHERE ${conditions.join(' AND ')}` : '';\n  \n  // limit e offset (validados para seguranÃ§a)\n  const limit = Math.min(Math.max(parseInt(q.limit) || 50, 1), 100);\n  const offset = Math.max(parseInt(q.offset) || 0, 0);\n  \n  // Construir query completa (LIMIT e OFFSET sÃ£o nÃºmeros validados, seguros)\n  const query = `SELECT lead_id, site_slug, name, email, phone, source, lead_type, priority, status, tags, message, ip_address, created_at, updated_at FROM elevea.leads ${whereClause} ORDER BY created_at DESC LIMIT ${limit} OFFSET ${offset}`;\n  \n  out.push({\n    json: {\n      query,\n      params,\n      limit,\n      offset,\n      filters: {\n        siteSlug: q.siteSlug || 'all',\n        status: q.status || 'all',\n        source: q.source || 'all',\n        leadType: q.leadType || 'all',\n        priority: q.priority ? Number(q.priority) : null,\n        startDate: isDate(q.startDate) ? q.startDate : null,\n        endDate: isDate(q.endDate) ? q.endDate : null\n      },\n      timestamp: new Date().toISOString()\n    }\n  });\n}\n\nreturn out;"
      },
      "id": "code-build-filter",
      "name": "ğŸ” Code - Build List Filter",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-752, 480]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ $json.query }}",
        "options": {
          "queryReplacement": "={{ $json.params }}"
        }
      },
      "id": "postgres-search-leads",
      "name": "ğŸ” PostgreSQL - Search Leads",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [-544, 480],
      "credentials": {
        "postgres": {
          "id": "S2Hp22T5AgilJMEy",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Formatar resposta de listagem\nconst leads = [];\nconst inputData = $input.all();\n\n// Processar leads retornados do PostgreSQL\nfor (const item of inputData) {\n  const lead = item.json;\n  leads.push({\n    id: lead.lead_id,\n    name: lead.name || 'N/A',\n    email: lead.email || null,\n    phone: lead.phone || null,\n    siteSlug: lead.site_slug || 'N/A',\n    source: lead.source || 'website',\n    leadType: lead.lead_type || 'general',\n    priority: Number(lead.priority) || 3,\n    status: lead.status || 'new',\n    tags: lead.tags ? (typeof lead.tags === 'string' ? lead.tags.split(', ').filter(Boolean) : []) : [],\n    message: lead.message || '',\n    createdAt: lead.created_at || null,\n    updatedAt: lead.updated_at || null,\n    ipAddress: lead.ip_address || null\n  });\n}\n\n// Obter filtros do nÃ³ anterior\nconst filterData = $('ğŸ” Code - Build List Filter').first();\nconst filters = filterData ? filterData.json.filters : {};\n\nreturn [{\n  json: {\n    success: true,\n    total: leads.length,\n    leads: leads,\n    filters: filters,\n    timestamp: new Date().toISOString()\n  }\n}];"
      },
      "id": "code-format-list",
      "name": "ğŸ“‹ Code - Format List Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-336, 480]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {}
      },
      "id": "respond-list",
      "name": "ğŸ“¤ Respond - List",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [-128, 480]
    }
  ],
  "connections": {
    "ğŸ¯ Webhook - Leads Capture": {
      "main": [
        [
          {
            "node": "ğŸ§¹ Code - Normalize + Validate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“‹ Webhook - Leads List": {
      "main": [
        [
          {
            "node": "ğŸ” Code - Build List Filter",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ§¹ Code - Normalize + Validate": {
      "main": [
        [
          {
            "node": "ğŸ”€ IF - Not Preflight",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”€ IF - Not Preflight": {
      "main": [
        [
          {
            "node": "â­ï¸ Code - Skip Rate Limit (Test)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ“¤ Respond - CORS",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "â­ï¸ Code - Skip Rate Limit (Test)": {
      "main": [
        [
          {
            "node": "â­ï¸ Code - Skip Idempotency (Test)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "â­ï¸ Code - Skip Idempotency (Test)": {
      "main": [
        [
          {
            "node": "ğŸ—„ï¸ PostgreSQL - Create Lead",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ—„ï¸ PostgreSQL - Create Lead": {
      "main": [
        [
          {
            "node": "ğŸ¯ Code - Format Capture Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ¯ Code - Format Capture Response": {
      "main": [
        [
          {
            "node": "ğŸ“¤ Respond - Capture",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ” Code - Build List Filter": {
      "main": [
        [
          {
            "node": "ğŸ” PostgreSQL - Search Leads",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ” PostgreSQL - Search Leads": {
      "main": [
        [
          {
            "node": "ğŸ“‹ Code - Format List Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“‹ Code - Format List Response": {
      "main": [
        [
          {
            "node": "ğŸ“¤ Respond - List",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 2,
  "updatedAt": "2025-01-XX",
  "versionId": "1"
}

