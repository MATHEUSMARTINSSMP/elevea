{
  "name": "Google Reviews - Fetch Data",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "api/google/reviews",
        "responseMode": "responseNode",
        "options": {
          "allowedOrigins": "*",
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "https://eleveaagencia.netlify.app"
              },
              {
                "name": "Access-Control-Allow-Methods",
                "value": "POST, OPTIONS"
              },
              {
                "name": "Access-Control-Allow-Headers",
                "value": "Content-Type, X-APP-KEY"
              }
            ]
          }
        }
      },
      "id": "webhook-reviews-fetch",
      "name": "ğŸ” Webhook - Reviews Fetch",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        240,
        300
      ],
      "webhookId": "google-reviews-fetch"
    },
    {
      "parameters": {
        "jsCode": "// Code - Normalize Input\nconst items = $input.all();\nconst out = [];\n\nfor (const item of items) {\n  const body = item.json.body || {};\n  const siteSlug = (body.siteSlug || '').trim().toLowerCase();\n  const userEmail = (body.userEmail || body.user_email || '').trim().toLowerCase();\n  const vipPin = (body.vipPin || body.vip_pin || '').trim();\n  \n  if (!siteSlug || !userEmail) {\n    out.push({\n      json: {\n        success: false,\n        error: 'siteSlug e userEmail sÃ£o obrigatÃ³rios',\n        siteSlug,\n        userEmail\n      }\n    });\n    continue;\n  }\n  \n  out.push({\n    json: {\n      customer_id: userEmail,\n      site_slug: siteSlug,\n      vip_pin: vipPin\n    }\n  });\n}\n\nreturn out;"
      },
      "id": "code-normalize-input",
      "name": "ğŸ“ Code - Normalize Input",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        460,
        300
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT customer_id, site_slug, access_token, refresh_token, expires_at, scopes, status, token_type, oauth_client_id, oauth_client_secret\nFROM elevea.google_credentials\nWHERE customer_id = $1 AND site_slug = $2 AND status = 'active'\nLIMIT 1",
        "options": {
          "queryReplacement": "=$1 â†’ {{$json.customer_id}}\n$2 â†’ {{$json.site_slug}}"
        }
      },
      "id": "postgres-get-credentials",
      "name": "ğŸ”‘ PostgreSQL - Get Credentials",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        680,
        300
      ],
      "credentials": {
        "postgres": {
          "id": "S2Hp22T5AgilJMEy",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Code - Token Check\nconst inputData = $input.all();\n\nif (inputData.length === 0) {\n  return [{\n    json: {\n      success: false,\n      ok: false,\n      error: 'Credenciais nÃ£o encontradas. Conecte sua conta Google primeiro.',\n      needRefresh: false,\n      needsReauth: true\n    }\n  }];\n}\n\n// PostgreSQL retorna dados diretamente em json, nÃ£o em json.rows\nconst row = inputData[0].json || {};\n\n// Verificar se tem os campos essenciais\nif (!row.access_token && !row.refresh_token) {\n  return [{\n    json: {\n      success: false,\n      ok: false,\n      error: 'Credenciais nÃ£o encontradas. Conecte sua conta Google primeiro.',\n      needRefresh: false,\n      needsReauth: true\n    }\n  }];\n}\n\nconst access_token = row.access_token || '';\nconst refresh_token = (row.refresh_token || '').trim();\nconst expires_at = row.expires_at ? new Date(row.expires_at).getTime() : null;\nconst now = Date.now();\n\nconst hasRefreshToken = refresh_token.length > 0;\nconst isExpired = expires_at ? now > (expires_at - 300000) : false; // 5 min antes\nconst needRefresh = hasRefreshToken && (!access_token || isExpired);\nconst needsReauth = !hasRefreshToken && (!access_token || isExpired);\n\n// Se precisa re-autenticar, retornar erro\nif (needsReauth) {\n  return [{\n    json: {\n      success: false,\n      ok: false,\n      error: 'Token expirado e sem refresh_token. Ã‰ necessÃ¡rio re-autenticar com o Google.',\n      needRefresh: false,\n      needsReauth: true\n    }\n  }];\n}\n\n// Extrair oauth_client_id e oauth_client_secret da linha do banco\nconst oauth_client_id = row.oauth_client_id || '';\nconst oauth_client_secret = row.oauth_client_secret || '';\n\nreturn [{\n  json: {\n    customer_id: row.customer_id,\n    site_slug: row.site_slug,\n    access_token: access_token,\n    refresh_token: refresh_token,\n    expires_at: expires_at ? new Date(expires_at).toISOString() : null,\n    scopes: row.scopes || '',\n    status: row.status || 'active',\n    token_type: row.token_type || 'Bearer',\n    needRefresh: needRefresh,\n    needsReauth: false,\n    oauth_client_id: oauth_client_id,\n    oauth_client_secret: oauth_client_secret\n  }\n}];"
      },
      "id": "code-token-check",
      "name": "ğŸ§ª Code - Token Check",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        900,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "// âš™ï¸ Code - OAuth Config\n// Multi-tenancy: Usar oauth_client_id e oauth_client_secret da tabela google_credentials\n// Busca diretamente da mesma linha que tem os tokens do usuÃ¡rio\n\nconst inputData = $input.all();\nconst tokenData = inputData.length > 0 ? inputData[0].json : {};\n\n// Buscar oauth_client_id e oauth_client_secret do Token Check (que jÃ¡ buscou do PostgreSQL)\nconst oauth = {\n  client_id: tokenData.oauth_client_id || '',\n  client_secret: tokenData.oauth_client_secret || '',\n  token_url: 'https://oauth2.googleapis.com/token',\n  redirect_uri: 'https://eleveaagencia.netlify.app/auth/google/callback'\n};\n\n// Validar se as credenciais estÃ£o configuradas\nif (!oauth.client_id || !oauth.client_secret) {\n  return [{\n    json: {\n      success: false,\n      ok: false,\n      error: 'Credenciais OAuth nÃ£o configuradas na tabela google_credentials. Adicione oauth_client_id e oauth_client_secret na linha correspondente ao customer_id e site_slug.',\n      needsReauth: true,\n      customer_id: tokenData.customer_id || '',\n      site_slug: tokenData.site_slug || ''\n    }\n  }];\n}\n\n// Retornar dados do Token Check + credenciais OAuth\nreturn [{\n  json: {\n    customer_id: tokenData.customer_id || '',\n    site_slug: tokenData.site_slug || '',\n    access_token: tokenData.access_token || '',\n    refresh_token: tokenData.refresh_token || '',\n    expires_at: tokenData.expires_at || null,\n    scopes: tokenData.scopes || '',\n    status: tokenData.status || 'active',\n    token_type: tokenData.token_type || 'Bearer',\n    needRefresh: tokenData.needRefresh || false,\n    needsReauth: tokenData.needsReauth || false,\n    oauth: oauth   // Adicionar credenciais OAuth\n  }\n}];"
      },
      "id": "code-oauth-config",
      "name": "âš™ï¸ Code - OAuth Config",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1100,
        180
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "condition-refresh",
              "leftValue": "={{$json.needRefresh}}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "if-need-refresh",
      "name": "ğŸ”€ IF - Need Refresh?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        1120,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "// Code - Prepare Refresh\nconst inputData = $input.all();\n\nif (inputData.length === 0) {\n  return [{\n    json: {\n      success: false,\n      error: 'Dados de token nÃ£o encontrados',\n      needsReauth: true\n    }\n  }];\n}\n\nconst tokenData = inputData[0].json || {};\nconst refresh_token = (tokenData.refresh_token || '').trim();\n\nif (!refresh_token || refresh_token.length === 0) {\n  return [{\n    json: {\n      success: false,\n      error: 'refresh_token nÃ£o disponÃ­vel. Ã‰ necessÃ¡rio re-autenticar com o Google.',\n      needsReauth: true,\n      customer_id: tokenData.customer_id,\n      site_slug: tokenData.site_slug\n    }\n  }];\n}\n\n// Buscar credenciais OAuth do input (que jÃ¡ vem do OAuth Config)\nconst oauthConfig = tokenData.oauth || {};\n\nif (!oauthConfig.client_id || !oauthConfig.client_secret) {\n  return [{\n    json: {\n      success: false,\n      error: 'Credenciais OAuth nÃ£o encontradas no input.',\n      needsReauth: true,\n      customer_id: tokenData.customer_id,\n      site_slug: tokenData.site_slug\n    }\n  }];\n}\n\nconst oauth = {\n  token_url: oauthConfig.token_url || 'https://oauth2.googleapis.com/token',\n  client_id: oauthConfig.client_id,\n  client_secret: oauthConfig.client_secret\n};\n\nreturn [{\n  json: {\n    url: oauth.token_url,\n    body: {\n      client_id: oauth.client_id,\n      client_secret: oauth.client_secret,\n      refresh_token: refresh_token,\n      grant_type: 'refresh_token'\n    },\n    customer_id: tokenData.customer_id,\n    site_slug: tokenData.site_slug,\n    refresh_token: refresh_token,\n    needsReauth: false\n  }\n}];"
      },
      "id": "code-prepare-refresh",
      "name": "ğŸ”„ Code - Prepare Refresh",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1120,
        180
      ]
    },
    {
      "parameters": {
        "url": "={{$json.url}}",
        "authentication": "none",
        "method": "POST",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "client_id",
              "value": "={{$json.body.client_id}}"
            },
            {
              "name": "client_secret",
              "value": "={{$json.body.client_secret}}"
            },
            {
              "name": "refresh_token",
              "value": "={{String($json.body.refresh_token)}}"
            },
            {
              "name": "grant_type",
              "value": "refresh_token"
            }
          ]
        },
        "options": {
          "bodyContentType": "x-form-urlencoded"
        }
      },
      "id": "http-refresh-token",
      "name": "ğŸŒ HTTP - Refresh Token",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1340,
        180
      ]
    },
    {
      "parameters": {
        "jsCode": "// Code - Process Refresh Response\nconst inputData = $input.all();\n\nif (inputData.length === 0) {\n  return [{\n    json: {\n      success: false,\n      error: 'Resposta de refresh nÃ£o encontrada'\n    }\n  }];\n}\n\nconst httpResponse = inputData[0].json || {};\nconst body = httpResponse.body || httpResponse;\n\nconst access_token = body.access_token || '';\nconst expires_in = body.expires_in || 3600;\nconst expires_at = Date.now() + (expires_in * 1000);\n\n// Obter dados originais do Prepare Refresh (que tem customer_id e site_slug)\nconst prepareRefresh = $('ğŸ”„ Code - Prepare Refresh').all();\nconst originalData = prepareRefresh && prepareRefresh.length > 0 ? prepareRefresh[0].json : {};\n\nif (!access_token) {\n  return [{\n    json: {\n      success: false,\n      error: 'access_token nÃ£o encontrado na resposta de refresh'\n    }\n  }];\n}\n\nreturn [{\n  json: {\n    customer_id: originalData.customer_id || '',\n    site_slug: originalData.site_slug || '',\n    access_token: access_token,\n    refresh_token: originalData.refresh_token || '', // Preservar refresh_token original\n    expires_at: expires_at,\n    token_type: body.token_type || 'Bearer',\n    scopes: originalData.scopes || '',\n    status: 'active'\n  }\n}];"
      },
      "id": "code-process-refresh",
      "name": "ğŸ“¦ Code - Process Refresh",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1560,
        180
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE elevea.google_credentials\nSET access_token = $1,\nexpires_at = TO_TIMESTAMP($2::numeric / 1000),\nupdated_at = NOW()\nWHERE customer_id = $3 AND site_slug = $4\nRETURNING customer_id, site_slug, access_token, refresh_token, expires_at",
        "options": {
          "queryReplacement": "=$1 â†’ {{$json.access_token}}\n$2 â†’ {{$json.expires_at}}\n$3 â†’ {{$json.customer_id}}\n$4 â†’ {{$json.site_slug}}"
        }
      },
      "id": "postgres-update-token",
      "name": "ğŸ’¾ PostgreSQL - Update Token",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1780,
        180
      ],
      "credentials": {
        "postgres": {
          "id": "S2Hp22T5AgilJMEy",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "mode": "combine",
        "fieldsToMatchString": "customer_id,site_slug",
        "options": {}
      },
      "id": "merge-token",
      "name": "ğŸ”€ Merge - Token",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        2000,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "// Code - Merge Token\nconst inputData = $input.all();\n\nif (inputData.length === 0) {\n  return [{\n    json: {\n      success: false,\n      error: 'Nenhum dado recebido'\n    }\n  }];\n}\n\nconst firstItem = inputData[0].json || {};\nif (firstItem.success === false || firstItem.error) {\n  return [{\n    json: {\n      success: false,\n      error: firstItem.error || 'Erro ao processar token',\n      needsReauth: firstItem.needsReauth || false\n    }\n  }];\n}\n\n// Se veio do IF False (nÃ£o precisa refresh), usar dados do OAuth Config\n// Se veio do PostgreSQL Update (refresh feito), usar dados atualizados\nconst tokenData = firstItem;\n\n// Se tem access_token atualizado (veio do refresh), usar ele\n// SenÃ£o, usar access_token original do OAuth Config\nconst access_token = tokenData.access_token || '';\nconst refresh_token = tokenData.refresh_token || '';\nconst expires_at = tokenData.expires_at || null;\n\n// Preservar customer_id e site_slug\nconst customer_id = tokenData.customer_id || '';\nconst site_slug = tokenData.site_slug || '';\n\nif (!access_token) {\n  return [{\n    json: {\n      success: false,\n      error: 'NÃ£o foi possÃ­vel obter access_token'\n    }\n  }];\n}\n\nreturn [{\n  json: {\n    access_token: access_token,\n    expires_at: expires_at,\n    refresh_token: refresh_token,\n    customer_id: customer_id,\n    site_slug: site_slug,\n    token_type: tokenData.token_type || 'Bearer'\n  }\n}];"
      },
      "id": "code-merge-token",
      "name": "ğŸ”§ Code - Merge Token",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2220,
        300
      ]
    },
    {
      "parameters": {
        "url": "https://mybusinessbusinessinformation.googleapis.com/v1/accounts",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{$json.token_type || 'Bearer'}} {{$json.access_token}}"
            }
          ]
        },
        "options": {}
      },
      "id": "http-list-accounts",
      "name": "ğŸŒ HTTP - List Accounts",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2440,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "// Code - Process Google Data\nconst inputData = $input.all();\n\nif (inputData.length === 0) {\n  return [{\n    json: {\n      success: false,\n      ok: false,\n      error: 'Nenhuma resposta do Google'\n    }\n  }];\n}\n\nconst httpResponse = inputData[0].json || {};\n\n// Verificar se hÃ¡ erro na resposta HTTP\nif (httpResponse.statusCode && httpResponse.statusCode >= 400) {\n  return [{\n    json: {\n      success: false,\n      ok: false,\n      error: `Erro ao buscar dados do Google: ${httpResponse.statusCode} - ${httpResponse.body?.error?.message || httpResponse.statusMessage || 'Erro desconhecido'}`\n    }\n  }];\n}\n\nconst accounts = httpResponse.body?.accounts || [];\n\nif (accounts.length === 0) {\n  return [{\n    json: {\n      success: false,\n      ok: false,\n      error: 'Nenhuma conta Google My Business encontrada'\n    }\n  }];\n}\n\n// Pegar primeira conta\nconst account = accounts[0];\nconst accountName = account.name || '';\n\n// Obter customer_id do Merge Token\nlet customerId = '';\ntry {\n  const mergeTokenData = $('ğŸ”§ Code - Merge Token').all();\n  if (mergeTokenData && mergeTokenData.length > 0) {\n    customerId = mergeTokenData[0].json.customer_id || '';\n  }\n} catch (e) {\n  console.error('Erro ao obter customer_id:', e);\n}\n\n// Por enquanto, retornar estrutura bÃ¡sica\n// TODO: Buscar locations, reviews, insights\nreturn [{\n  json: {\n    ok: true,\n    success: true,\n    account: {\n      name: accountName,\n      accountName: accountName\n    },\n    reviews: [],\n    averageRating: 0,\n    totalReviews: 0,\n    businessInfo: {\n      name: 'NegÃ³cio conectado',\n      accountEmail: customerId\n    },\n    connectedAt: new Date().toISOString(),\n    lastUpdated: new Date().toISOString()\n  }\n}];"
      },
      "id": "code-process-google",
      "name": "ğŸ“Š Code - Process Google Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2660,
        300
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{$json}}",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "https://eleveaagencia.netlify.app"
              }
            ]
          }
        }
      },
      "id": "respond-success",
      "name": "âœ… Respond - Success",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        2880,
        300
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{$json}}",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "https://eleveaagencia.netlify.app"
              }
            ]
          }
        }
      },
      "id": "respond-error",
      "name": "âŒ Respond - Error",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        2000,
        500
      ]
    }
  ],
  "connections": {
    "ğŸ” Webhook - Reviews Fetch": {
      "main": [
        [
          {
            "node": "ğŸ“ Code - Normalize Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“ Code - Normalize Input": {
      "main": [
        [
          {
            "node": "ğŸ”‘ PostgreSQL - Get Credentials",
            "type": "main",
            "index": 0
          },
          {
            "node": "âŒ Respond - Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”‘ PostgreSQL - Get Credentials": {
      "main": [
        [
          {
            "node": "ğŸ§ª Code - Token Check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ§ª Code - Token Check": {
      "main": [
        [
          {
            "node": "âš™ï¸ Code - OAuth Config",
            "type": "main",
            "index": 0
          },
          {
            "node": "âŒ Respond - Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”€ IF - Need Refresh?": {
      "main": [
        [
          {
            "node": "ğŸ”„ Code - Prepare Refresh",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ”€ Merge - Token",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”„ Code - Prepare Refresh": {
      "main": [
        [
          {
            "node": "ğŸŒ HTTP - Refresh Token",
            "type": "main",
            "index": 0
          },
          {
            "node": "âŒ Respond - Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸŒ HTTP - Refresh Token": {
      "main": [
        [
          {
            "node": "ğŸ“¦ Code - Process Refresh",
            "type": "main",
            "index": 0
          },
          {
            "node": "âŒ Respond - Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“¦ Code - Process Refresh": {
      "main": [
        [
          {
            "node": "ğŸ’¾ PostgreSQL - Update Token",
            "type": "main",
            "index": 0
          },
          {
            "node": "âŒ Respond - Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ’¾ PostgreSQL - Update Token": {
      "main": [
        [
          {
            "node": "ğŸ”€ Merge - Token",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”€ Merge - Token": {
      "main": [
        [
          {
            "node": "ğŸ”§ Code - Merge Token",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”§ Code - Merge Token": {
      "main": [
        [
          {
            "node": "ğŸŒ HTTP - List Accounts",
            "type": "main",
            "index": 0
          },
          {
            "node": "âŒ Respond - Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸŒ HTTP - List Accounts": {
      "main": [
        [
          {
            "node": "ğŸ“Š Code - Process Google Data",
            "type": "main",
            "index": 0
          },
          {
            "node": "âŒ Respond - Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“Š Code - Process Google Data": {
      "main": [
        [
          {
            "node": "âœ… Respond - Success",
            "type": "main",
            "index": 0
          },
          {
            "node": "âŒ Respond - Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "âš™ï¸ Code - OAuth Config": {
      "main": [
        [
          {
            "node": "ğŸ”€ IF - Need Refresh?",
            "type": "main",
            "index": 0
          },
          {
            "node": "âŒ Respond - Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "updatedAt": "2024-11-09T03:20:00.000Z",
  "versionId": "1"
}